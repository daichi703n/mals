//This JavaScript get MALS registered link, and Replace HTML View
//https://mals.herokuapp.com
function getLink(){
  // Select item on Server Side
  const got_link = new Promise((resolve,reject) => {
    const request = new XMLHttpRequest()
    request.open("GET", link_api, true)
    request.timeout = 30000; // time in milliseconds
    //Success
    request.addEventListener("load", (event) => {resolve(event.target.responseText)})
    //Fail
    request.ontimeout = function(e) {
      console.error("Request timed out - Please contact site owner or MALS help")
    }
    request.addEventListener("load", (event) => {
      if(event.target.status != 200){
        reject(console.error("HTTP Status: "+event.target.status+" - Please contact site owner or MALS help"));
      }
    });
    request.addEventListener("error", () => {
        reject(console.error("Network Error - Please contact site owner or MALS help"));
    });
    request.send()
  })
  return got_link
}

async function setLink(){
  const selected_link = await getLink()
  const target=document.getElementById("mals_replace_target")
  //ToDo: in Advanced edition, msg can be unvisible
  target.innerHTML = JSON.parse(selected_link)//+msg
  console.log("Ad Link is Generated by MALS "+root_url)
}

function getQuery(path) {
    if(path.indexOf("?") == -1){
      console.log("Error: MalsKey is not set"); return;
    }
    const variables = path.split("?")[1].split("&");
    const obj = {};
    variables.forEach(function(v, i) {
        const variable = v.split("=");
        obj[variable[0]] = String(variable[1]);
    });
    return obj;
}

const jsPath = (function() {
    if (document.currentScript) {
        return document.currentScript.src;
    } else {
        const scripts = document.getElementsByTagName('script'),
        script = scripts[scripts.length-1];
        if (script.src) {
            return script.src;
        }
    }
})();

if (window.location.pathname == "/feature_pages/view"){
  var root_url = window.location.protocol+"//"+window.location.host
} else {
  var root_url = "https://mals.herokuapp.com"
}

const query = getQuery(jsPath)
const link_api = root_url+"/api/selector/v1/links/random?"+"malskey="+query.malskey
//ToDo: in Advanced edition, msg will be unvisible
const msg = '<div id="mals_message"><font color="lightgray">'+
'<a href='+root_url+' target="_blank">This Link is Generated by MALS</a><br>'+
'</font></div>'

setLink()
